<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>SPARKI JUNIOR - Fun Shapes</title>
<script src="https://unpkg.com/blockly/blockly.min.js"></script>
<style>
html, body { height:100%; margin:0; font-family:Arial, Helvetica, sans-serif; background:#f7fbff; }
#topBar { background:#2b6cb0; color:white; padding:10px; display:flex; gap:10px; align-items:center; }
button { padding:10px 18px; font-size:15px; border:none; border-radius:8px; cursor:pointer; color:white; }
#connectBtn { background:#16a34a; }
#runBtn { background:#0ea5e9; }
#blocklyDiv { height:calc(100% - 56px); width:100%; }
h1 { margin:0; font-size:18px; }
.small { font-size:12px; opacity:0.9; }
#status { margin-left:10px; font-weight:bold; padding:6px 10px; border-radius:8px; font-size:14px; background:#ff4d4d; color:white;}
#keypad { position: fixed; right: 20px; bottom: 20px; display: grid; grid-template-columns: repeat(3, 60px); gap: 10px; cursor: move; background: #1E3A8A; padding: 10px; border-radius: 12px; z-index:1000; }
.keypad-btn { padding: 15px; font-size: 18px; border-radius: 8px; background:#3B82F6; color:white; cursor:pointer; border:none; }
.keypad-btn:hover { background:#2563EB; }
</style>
</head>
<body>
<div id="topBar">
  <div>
    <h1>SPARKI JUNIOR</h1>
  </div>
  <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
    <button id="connectBtn">üîå Connect</button>
    <button id="runBtn">‚ñ∂</button>
    <div id="status">üî¥ Not Connected</div>
  </div>
</div>

<div id="blocklyDiv"></div>

<!-- Keypad UI -->
<div id="keypad">
  <button class="keypad-btn" data-key="‚Üë">‚Üë</button>
  <button class="keypad-btn" data-key="‚Üì">‚Üì</button>
  <button class="keypad-btn" data-key="3">3</button>
  <button class="keypad-btn" data-key="‚Üê">‚Üê</button>
  <button class="keypad-btn" data-key="‚Üí">‚Üí</button>
  <button class="keypad-btn" data-key="6">6</button>
  <button class="keypad-btn" data-key="7">X</button>
  <button class="keypad-btn" data-key="repeat">üîÅ</button>
  <button class="keypad-btn" data-key="9">9</button>
  <button class="keypad-btn" data-key="0">GO</button>
  <button class="keypad-btn" data-key="A">A</button>
  <button class="keypad-btn" data-key="B">B</button>
</div>


<!-- TOOLBOX -->
<xml id="toolbox" style="display:none">
  <category name="Events" colour="#FFD700">
    <block type="when_run"></block>
  </category>
  <category name="Moves" colour="#FF7043">
    <block type="move_forward"></block>
    <block type="move_backward"></block>
    <block type="turn_left"></block>
    <block type="turn_right"></block>
    <block type="turn_left_45"></block>
    <block type="turn_right_45"></block>
    <block type="wait"></block>
    <block type="repeat"></block>
  </category>
  <category name="Drawing" colour="#8A2BE2">
    <block type="draw_square"></block>
    <block type="draw_rectangle"></block>
    <block type="draw_circle"></block>
    <block type="draw_triangle"></block>
    <block type="draw_line"></block>
    <block type="draw_heart"></block>
    <block type="draw_star"></block>
    <block type="draw_fish"></block>
    <block type="draw_spiral"></block>
    <block type="draw_lollipop"></block>
  </category>
  <category name="Actions" colour="#1E90FF">
    <block type="clear_moves"></block>
    <block type="emergency_stop"></block>
  </category>
</xml>

<script>
// ----------------- Define Blocks -----------------
Blockly.defineBlocksWithJsonArray([
  { "type":"when_run","message0":"When Run Clicked","nextStatement":null,"colour":30 },
  { "type":"move_forward","message0":"Forward","previousStatement":null,"nextStatement":null,"colour":0 },
  { "type":"move_backward","message0":"Backward","previousStatement":null,"nextStatement":null,"colour":0 },
  { "type":"turn_left","message0":"Left (90¬∞)","previousStatement":null,"nextStatement":null,"colour":60 },
  { "type":"turn_right","message0":"Right (90¬∞)","previousStatement":null,"nextStatement":null,"colour":60 },
  { "type":"turn_left_45","message0":"Left (45¬∞)","previousStatement":null,"nextStatement":null,"colour":60 },
  { "type":"turn_right_45","message0":"Right (45¬∞)","previousStatement":null,"nextStatement":null,"colour":60 },
  { "type":"wait","message0":"Wait %1 ms","args0":[{"type":"field_number","name":"TIME","value":500}],"previousStatement":null,"nextStatement":null,"colour":120 },
  { "type":"repeat","message0":"Repeat %1 times","args0":[{"type":"field_number","name":"TIMES","value":2}],"previousStatement":null,"nextStatement":null,"colour":180,"message1":"%1","args1":[{"type":"input_statement","name":"DO"}]},
  { "type":"clear_moves","message0":"Clear Moves (0)","previousStatement":null,"nextStatement":null,"colour":0 },
  { "type":"emergency_stop","message0":"Emergency Stop (7)","previousStatement":null,"nextStatement":null,"colour":0 },
  { "type":"draw_square","message0":"Draw Square","previousStatement":null,"nextStatement":null,"colour":200 },
  { "type":"draw_rectangle","message0":"Draw Rectangle","previousStatement":null,"nextStatement":null,"colour":200 },
  { "type":"draw_circle","message0":"Draw Circle","previousStatement":null,"nextStatement":null,"colour":200 },
  { "type":"draw_triangle","message0":"Draw Triangle","previousStatement":null,"nextStatement":null,"colour":200 },
  { "type":"draw_line","message0":"Draw Line","previousStatement":null,"nextStatement":null,"colour":200 },
  { "type":"draw_heart","message0":"Draw Heart","previousStatement":null,"nextStatement":null,"colour":260 },
  { "type":"draw_star","message0":"Draw Star","previousStatement":null,"nextStatement":null,"colour":260 },
  { "type":"draw_fish","message0":"Draw Fish","previousStatement":null,"nextStatement":null,"colour":260 },
  { "type":"draw_spiral","message0":"Draw Spiral","previousStatement":null,"nextStatement":null,"colour":260 },
  { "type":"draw_lollipop","message0":"Draw Lollipop","previousStatement":null,"nextStatement":null,"colour":260 }
]);

// ----------------- Blockly Generators -----------------
const js = Blockly.JavaScript;
js.forBlock['when_run'] = () => "";
js.forBlock['move_forward'] = () => "await sendSerial('1');\n";
js.forBlock['move_backward'] = () => "await sendSerial('2');\n";
js.forBlock['turn_left'] = () => "await sendSerial('4');\n";
js.forBlock['turn_right'] = () => "await sendSerial('5');\n";
js.forBlock['turn_left_45'] = () => "await sendSerial('L');\n";
js.forBlock['turn_right_45'] = () => "await sendSerial('R');\n";
js.forBlock['wait'] = b => `await delay(${b.getFieldValue("TIME")});\n`;
js.forBlock['repeat'] = b => { const n = b.getFieldValue("TIMES"); const code = js.statementToCode(b,'DO'); return `for(let i=0;i<${n};i++){${code}}\n`;};
js.forBlock['clear_moves'] = () => "await sendSerial('0');\n";
js.forBlock['emergency_stop'] = () => "await sendSerial('7');\n";
js.forBlock['draw_square'] = () => `for(let i=0;i<4;i++){await sendSerial('1'); await delay(300); await sendSerial('5'); await delay(300);}`;
js.forBlock['draw_rectangle'] = () => `for(let i=0;i<2;i++){await sendSerial('1'); await delay(1000); await sendSerial('5'); await delay(300); await sendSerial('1'); await delay(500); await sendSerial('5'); await delay(300);}`;
js.forBlock['draw_circle'] = () => `for(let i=0;i<9;i++){await sendSerial('1'); await delay(150); await sendSerial('R'); await delay(150);}`;
js.forBlock['draw_triangle'] = () => `for(let i=0;i<3;i++){await sendSerial('1'); await delay(400); await sendSerial('5'); await delay(400);}`;
js.forBlock['draw_line'] = () => `for(let i=0;i<6;i++){await sendSerial('1'); await delay(250);}`;
js.forBlock['draw_heart'] = () => `await sendSerial('R'); await delay(250);for(let i=0;i<6;i++){await sendSerial('1'); await delay(200);} await sendSerial('L'); await delay(250);for(let i=0;i<6;i++){await sendSerial('1'); await delay(200);} await sendSerial('4'); await delay(500);await sendSerial('1'); await delay(350);`;
js.forBlock['draw_star'] = () => `for(let i=0;i<5;i++){await sendSerial('1'); await delay(700); await sendSerial('5'); await delay(500); await sendSerial('R'); await delay(250);}`;
js.forBlock['draw_fish'] = () => `for(let i=0;i<12;i++){await sendSerial('1'); await delay(150); await sendSerial('R'); await delay(80);}for(let i=0;i<12;i++){await sendSerial('1'); await delay(150); await sendSerial('L'); await delay(80);}await sendSerial('5'); await delay(300);await sendSerial('1'); await delay(200);await sendSerial('4'); await delay(300);await sendSerial('1'); await delay(200);`;
js.forBlock['draw_spiral'] = () => `let step=150;for(let i=0;i<10;i++){await sendSerial('1'); await delay(step); await sendSerial('R'); await delay(250); step+=70;}`;
js.forBlock['draw_lollipop'] = () => `for(let i=0;i<24;i++){await sendSerial('1'); await delay(120); await sendSerial('R'); await delay(120);}await sendSerial('4'); await delay(500);for(let i=0;i<3;i++){await sendSerial('1'); await delay(400);}`;

// ----------------- Blockly Init -----------------
const workspace = Blockly.inject('blocklyDiv',{
  toolbox: document.getElementById('toolbox'),
  trashcan: true,
  scrollbars: true,
  zoom: { controls:true, wheel:true, startScale:1.2, maxScale:3, minScale:0.3 }
});

// ----------------- Serial Communication -----------------
let port = null;
let writer = null;

function updateStatus(connected){
  const s = document.getElementById("status");
  if(connected){ s.innerHTML = "üü¢ Connected"; s.style.background = "#22c55e"; }
  else { s.innerHTML = "üî¥ Not Connected"; s.style.background = "#ff4d4d"; }
}

async function connectSerial(){
  try{
    if(!port){
      port = await navigator.serial.requestPort();
      await port.open({baudRate:9600});
      writer = port.writable.getWriter();
      updateStatus(true);
      port.addEventListener("disconnect", ()=>{ writer = null; port = null; updateStatus(false); });
      alert("Connected to Arduino!");
    }
  } catch(e){ alert("Serial connection error: " + e); updateStatus(false); }
}

async function sendSerial(c){
  if(!writer){ updateStatus(false); await connectSerial(); }
  await new Promise(r=>setTimeout(r,20));
  await writer.write(new Uint8Array([c.charCodeAt(0)]));
}

const delay = ms => new Promise(res => setTimeout(res, ms));

async function runCode(){
  if(!writer){ await connectSerial(); }
  await sendSerial('0');
  await delay(100);
  const code = js.workspaceToCode(workspace);
  const fn = new Function('sendSerial','delay',`return (async()=>{${code}})();`);
  await fn(sendSerial, delay);
}

document.getElementById('connectBtn').onclick = connectSerial;
document.getElementById('runBtn').onclick = runCode;

// ----------------- Keypad Logic -----------------
document.querySelectorAll('.keypad-btn').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    const key = btn.dataset.key;
    await sendSerial(key);
  });
});

// ----------------- Draggable Keypad -----------------
const keypad = document.getElementById('keypad');
let offsetX, offsetY, isDragging = false;

keypad.addEventListener('mousedown', e => {
  isDragging = true;
  offsetX = e.clientX - keypad.offsetLeft;
  offsetY = e.clientY - keypad.offsetTop;
});

document.addEventListener('mousemove', e => {
  if(isDragging){
    keypad.style.left = (e.clientX - offsetX) + 'px';
    keypad.style.top = (e.clientY - offsetY) + 'px';
    keypad.style.right = 'auto';
    keypad.style.bottom = 'auto';
  }
});

document.addEventListener('mouseup', () => { isDragging = false; });

</script>
</body>
</html>